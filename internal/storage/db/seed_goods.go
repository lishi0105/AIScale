package foodDB

import (
	"context"
	"fmt"
	"sort"
	"strings"
	"time"

	category "hdzk.cn/foodapp/internal/domain/category"
	dict "hdzk.cn/foodapp/internal/domain/dict"
	"hdzk.cn/foodapp/internal/domain/goods"
	"hdzk.cn/foodapp/pkg/logger"

	"go.uber.org/zap"
	"gorm.io/gorm"
	"gorm.io/gorm/clause"
)

// 商品基础数据（根据默认品类、规格预制）
var defaultGoods = []struct {
	Name               string
	CategoryName       string
	UnitName           string
	SpecName           string
	AcceptanceStandard string
}{
	// --- 肉类 ---
	{"边散猪肉", "肉类", "斤", "新鲜", "肉质有弹性, 手指轻按, 凹陷地方马上恢复, 脂肪为白色或乳白色, 整体色泽光润, 切面红色、微微湿润但不沾手; 无淤血、无注水, 无寄生虫。"},
	{"上肉", "肉类", "斤", "新鲜", "瘦肉较多, 带有肥肉或瘦肉。"},
	{"五花肉", "肉类", "斤", "新鲜", "带皮的肥瘦肉, 或瘦肉。"},
	{"瘦肉", "肉类", "斤", "新鲜", "基本为瘦肉, 无肥肉, 肌腱少。"},
	{"猪扒", "肉类", "斤", "新鲜", "圆而长的通脊肉, 全部都是瘦肉, 肉质细嫩, 紧密。"},
	{"排骨", "肉类", "斤", "新鲜", "带肉的排骨, 排骨带少量肉, 不带肥油, 厚实, 骨肉不分离。"},
	{"龙骨", "肉类", "斤", "新鲜", "剔除了里脊肉的脊椎骨, 色泽肉红, 不带皮, 不带油。"},
	{"汤骨", "肉类", "斤", "新鲜", "腿骨, 圆筒形, 浅黄骨髓充满全部管状骨腔, 带部分肌肉"},
	{"猪蹄", "肉类", "斤", "新鲜", "干净、完整、无毛、无黑斑、无指甲、表皮光滑、肉质油弹性"},
	{"猪肝", "肉类", "斤", "新鲜", "肝叶完整、暗红、质地柔软、湿润、有光泽、边缘薄。"},
	{"猪心", "肉类", "斤", "新鲜", "心冠脂肪洁白, 组织结实有弹性, 用手可挤出鲜红的血液和血凝结块。"},
	{"猪肺", "肉类", "斤", "新鲜", "内呈红色, 有光泽。"},
	{"猪腰", "肉类", "斤", "新鲜", "表面有一层光亮的薄膜, 呈浅红色, 柔软有光泽, 有弹性。"},
	{"猪大肠", "肉类", "斤", "新鲜", "呈浅黄, 无黑斑, 柔软, 表面光滑湿润, 无异味, 极小味道。"},
	{"猪肚", "肉类", "斤", "新鲜", "呈浅白, 色泽光润, 不带肥油, 内部干净, 无异味, 极小味道。"},
	{"猪耳", "肉类", "斤", "新鲜", "无毛或少毛, 无异味, 色泽正常。"},
	{"鲜牛肉", "肉类", "斤", "新鲜", "肉色深红, 肉质有弹性, 指压凹陷部分会立刻恢复, 切面有光泽及微湿润, 极少渗出物; 具有浓郁牛肉气味, 脂肪白色或乳白色; 无寄生虫, 无注水。"},
	{"鸭", "肉类", "只", "新鲜不杀", "表皮光滑而有光泽, 肉质弹性好且丰满, 表皮无毛或少毛, 无破皮, 无花皮, 无显眼淤块, 无注水, 肚内无一切内脏、无血水、无异味。"},
	{"鸡", "肉类", "只", "新鲜不杀", "大小符合要求, 鸡肚内无一切内脏, 眼球饱满, 皮肤有光泽, 因品种不同而呈淡黄、淡红、灰白或灰黑等色, 外表微干或微湿润不沾手, 指压立即恢复, 具有鲜鸡肉正常气味, 无淤血斑或极少, 无打水症状, 无破皮。"},
	{"鸡中翼", "肉类", "斤", "新鲜", "无黄衣, 大小均匀, 无异味, 无碎杂, 有光泽; 无明显淤块, 无破皮, 外表色泽正常, 无肉质淡红, 无鸡毛。"},
	{"鸡爪", "肉类", "斤", "新鲜", "大小均匀, 色泽乳白; 无粘手, 无异味, 无黑斑, 无碎架, 瓜底部无硬结。"},
	{"鸡全翼", "肉类", "斤", "新鲜", "大小均匀, 无碎杂, 有光泽; 无异味, 肉色淡红, 无骨折和破皮, 无黄衣, 无异味, 无鸡毛。"},
	{"鸡腿", "肉类", "只", "新鲜", "大小均匀, 无碎杂, 无黄衣, 无淤血斑, 有光泽, 肉质淡红, 无异味。"},
	{"鸡肾", "肉类", "斤", "新鲜", "呈鸡肾特有色泽, 无病斑, 外表及切面湿润, 但不粘手; 无污物及其他肉眼可分杂质; 无异味。"},

	// --- 干货 ---
	{"干货", "干货", "斤", "散装", "有外包装的必须标明产品名称、配料表、净含量、制造者及经营者的名称和地址、生产(或分装、包装)日期、保质期或保存期、产品标准号。"},

	// --- 牛奶 ---
	{"盒装牛奶", "牛奶", "盒", "盒装", "具有SC(QS)标志, 独立纸质盒装; 必须采用超高温瞬时灭菌或保持灭菌支撑, 无菌罐装; 外包装无污物, 无泄漏。"},

	// --- 豆类淀粉制品 ---
	{"粉皮", "豆类淀粉制品", "斤", "散装", "乳白色, 半透明有光泽, 无酸味, 方或圆形, 揭开完整不碎, 稍有韧性。"},
	{"麻腐", "豆类淀粉制品", "斤", "散装", "乳白色, 半透明有光泽, 无酸味, 块形完整, 有弹性。"},
	{"水粉丝", "豆类淀粉制品", "斤", "散装", "乳白色, 半透明有光泽, 无酸味, 长线型, 无珠子粒, 有韧性。"},

	// --- 调料 ---
	{"调料", "调料", "斤", "散装", "具有SC(QS)标志, 外包装无污物, 无泄漏, 无胀袋或胖听或鼓盖现象, 无变质发霉现象, 色泽正常, 具有该品种固定的香味、滋味无异味; 油酱均匀的酱体或无结块的粉状固体, 封口平整, 无破包, 夹包、漏包, 无污染; 香辛料要求干燥、无虫蛀、无霉变、无异味、无污染、无杂质; 验收时, 调料生产日期不超过保质期的三分之一。"},

	// --- 果蔬 ---
	{"小白菜", "果蔬", "斤", "新鲜", "梗白色, 较嫩较短, 叶子淡绿色, 整棵菜水分充足, 无根。"},
	{"青菜", "果蔬", "斤", "新鲜", "梗白色或浅绿色, 较嫩, 叶子深绿色, 整棵菜水分充足, 无根。"},
	{"菜秧", "果蔬", "斤", "新鲜", "梗较细较嫩, 叶子细长, 淡绿色, 棵小似鸡毛, 水分充足。"},
	{"油菜", "果蔬", "斤", "新鲜", "梗粗短, 呈淡绿色或白色, 叶子肥厚大, 主茎无花蕾, 水分充足, 无根。"},
	{"韭菜", "果蔬", "斤", "新鲜", "叶较宽, 挺直, 翠绿色, 根部洁白软嫩且有韭菜味, 根株均匀, 长20厘米以内。"},
	{"韭黄", "果蔬", "斤", "新鲜", "叶肥挺, 稍弯曲, 色泽淡黄, 香味浓郁, 长20厘米以内。"},
	{"香芹", "果蔬", "斤", "新鲜", "叶翠绿, 无主茎分支少, 根细, 茎挺直, 脆, 芹菜香味, 水分充足, 长约30厘米。"},
	{"水芹", "果蔬", "斤", "新鲜", "叶嫩绿黄绿, 茎、根部呈白色, 茎细软, 中间空, 水份充足, 有清香味, 长约30厘米。"},
	{"西芹", "果蔬", "斤", "新鲜", "叶茎宽厚, 验收深绿, 新鲜肥嫩, 爽口无渣。"},
	{"菠菜", "果蔬", "斤", "新鲜", "颜色碧绿, 平嫩, 叶子大, 挺直, 根桃红, 无主茎且无柄无红色。"},
	{"生菜", "果蔬", "斤", "新鲜", "颜色碧绿, 淡绿, 叶子水分充足, 脆嫩薄, 可竖起, 棵株挺直。"},
	{"空心菜", "果蔬", "斤", "新鲜", "叶薄小而翠绿, 有光泽, 棵株挺直, 梗细脆嫩, 淡绿色易折断, 水分充足, 棵株挺直。"},
	{"西洋菜", "果蔬", "斤", "新鲜", "颜色淡绿或深绿, 茎细脆嫩, 易折断, 水份充足, 棵株挺直。"},
	{"麦菜", "果蔬", "斤", "新鲜", "叶淡绿, 肥厚, 脆嫩, 无主茎, 叶株挺直, 水份充足, 根部的切面嫩绿色稍有苦涩味。"},
	{"芥菜", "果蔬", "斤", "新鲜", "叶大而薄, 深绿色, 柄嫩绿脆, 无主茎, 叶株挺直, 水份充足。"},
	{"苋菜", "果蔬", "斤", "新鲜", "有红绿两种, 叶子为绿色或红色, 叶大薄软, 有光泽, 茎细短, 光滑嫩脆, 棵株挺直, 水份充足。"},
	{"潺菜", "果蔬", "斤", "新鲜", "颜色碧绿, 叶厚实, 有光泽, 梗细短, 光滑嫩绿, 抿之易断。"},
	{"菜芯", "果蔬", "斤", "新鲜", "颜色碧绿, 梗脆嫩, 抿之易断, 棵株挺直, 水份充足。"},
	{"芥兰", "果蔬", "斤", "新鲜", "颜色墨绿, 叶短少, 有白霜, 挺直, 梗皮有光泽, 绿色, 粗长, 断面绿白色, 湿润。"},
	{"小葱", "果蔬", "斤", "新鲜", "叶翠绿, 饱满充气, 均匀细长, 鳞茎洁白, 挺直, 香味浓郁, 长15-30厘米。"},
	{"胡葱", "果蔬", "斤", "新鲜", "叶翠绿, 饱满充气, 均匀细长, 鳞茎洁白, 挺直, 香味浓郁, 长15-31厘米。"},
	{"青蒜", "果蔬", "斤", "新鲜", "叶翠绿, 薄嫩, 挺直, 蒜茎洁白, 水份充足。"},
	{"香菜", "果蔬", "斤", "新鲜", "翠绿, 挺直, 根部无泥, 香气重。"},
	{"青椒", "果蔬", "斤", "新鲜", "颜色碧绿, 有光泽, 表面光滑。"},
	{"西椒", "果蔬", "斤", "新鲜", "柿形或灯笼形, 较大, 颜色碧绿, 肉厚少籽。"},
	{"辣椒", "果蔬", "斤", "新鲜", "细长圆锥形, 颜色黄绿或碧绿, 有光泽, 饱满有一定硬度, 辣味重。"},
	{"红椒", "果蔬", "斤", "新鲜", "颜色红艳, 有光泽, 表面光滑, 饱满有一定硬度。"},
	{"番茄", "果蔬", "斤", "新鲜", "颜色大红, 粉色, 或黄色, 光泽亮眼, 个大圆整, 酸中带甜。"},
	{"大白", "果蔬", "斤", "新鲜", "外叶淡绿色, 叶新鲜光泽, 棵株大, 包心坚实紧密。"},
	{"包菜", "果蔬", "斤", "新鲜", "外叶淡绿色, 内页淡黄色, 叶肥厚嫩脆, 棵株大, 根部断面洁白完整。"},
	{"大葱", "果蔬", "斤", "新鲜", "叶为管状, 浅绿色, 葱白长, 挺直, 长约50厘米。"},
	{"茄子", "果蔬", "斤", "新鲜", "色正形正, 表面光滑有光泽, 有弹性不软, 皮薄肉嫩籽少, 个体均匀。"},
	{"莴笋", "果蔬", "斤", "新鲜", "形粗壮, 条直, 均匀, 叶绿色, 茎皮光泽。"},
	{"蒜苔", "果蔬", "斤", "新鲜", "颜色深绿, 梗细滑, 有光泽, 挺直, 鲜嫩, 指甲掐之易断。"},
	{"花菜", "果蔬", "斤", "新鲜", "花蕾颜色洁白或乳白, 球形完整, 表面湿润, 外叶绿色较少, 断面洁白。"},
	{"西兰花", "果蔬", "斤", "新鲜", "花蕾颜色深绿, 球形完整表面有白霜, 花梗深绿色, 紧凑, 主茎短。"},
	{"黄瓜", "果蔬", "斤", "新鲜", "颜色青绿, 瓜身细短, 条直均匀, 瓜把小, 顶花带刺, 有白霜或光泽, 肉脆甜。"},
	{"冬瓜", "果蔬", "斤", "新鲜", "皮青翠, 有白霜, 肉洁白, 厚嫩, 紧密, 有一定硬度。"},
	{"苦瓜", "果蔬", "斤", "新鲜", "淡绿色, 有光泽, 凸处明显, 条直均匀, 有一定硬度, 籽小, 苦味。"},
	{"丝瓜", "果蔬", "斤", "新鲜", "有棱和无棱两种, 皮颜色翠绿, 薄嫩, 有白霜, 条直均匀, 易断无弹性, 肉洁白软嫩, 籽小。"},
	{"毛瓜", "果蔬", "斤", "新鲜", "颜色翠绿有光泽, 有细绒毛, 皮薄嫩, 肉洁白籽小, 形正有一定硬度。"},
	{"南瓜", "果蔬", "斤", "新鲜", "颜色金黄色或橙黄色, 瓜形周正, 肉金黄色紧密, 粉甜表面硬实。"},
	{"佛手瓜", "果蔬", "斤", "新鲜", "颜色浅绿, 佛手型, 有一定硬度, 皮脆硬, 肉晶莹剔透, 瓜形正。"},
	{"角瓜", "果蔬", "斤", "新鲜", "颜色黄绿色, 表皮光滑有花纹和棱边, 皮薄肉嫩, 籽小, 有一定硬度"},
	{"新豆", "果蔬", "斤", "新鲜", "颜色淡绿有光泽, 豆荚细长, 均匀, 饱满, 有花蒂, 有弹性折之易断。"},
	{"毛豆", "果蔬", "斤", "新鲜", "颜色青绿, 表面有黄色绒毛, 豆荚饱满, 拨开后豆粒呈淡绿色, 有清香。"},
	{"青豆", "果蔬", "斤", "新鲜", "颜色青绿单一, 有光泽, 豆粒大, 均匀完整, 较嫩。"},
	{"四季豆", "果蔬", "斤", "新鲜", "颜色脆绿色, 表面有细绒毛, 豆荚细长均匀, 水分充足, 饱满有韧性, 能弯曲, 指甲掐之后有痕, 断之容易。"},
	{"荷兰豆", "果蔬", "斤", "新鲜", "颜色嫩绿有光泽, 豆荚挺直, 折之易断, 筋丝不明显, 豆粒小而无。"},
	{"绿豆芽", "果蔬", "斤", "新鲜", "豆芽挺直, 芽身短而粗, 根须少, 芽色洁白晶莹。"},
	{"土豆", "果蔬", "斤", "新鲜散装", "颜色为淡黄色或奶白色, 个形大, 大小整齐, 表皮光滑, 体硬不软, 饱满。"},
	{"洋葱", "果蔬", "斤", "新鲜", "鳞片颜色粉白或紫白, 鳞片肥厚, 完整无损, 饱和紧实, 球茎干度适中, 有一定硬度。"},
	{"红薯", "果蔬", "斤", "新鲜", "颜色粉红或淡黄色, 依品种而定, 个大形正, 大小整齐, 表面无伤, 体硬不软, 饱满。"},
	{"生姜", "果蔬", "斤", "新鲜", "颜色淡黄, 表皮完整, 姜体脆硬, 肥大有姜味。"},
	{"蒜头", "果蔬", "斤", "新鲜", "颜色白色, 或紫色, 蒜皮干燥, 蒜瓣结实不散, 有硬度。"},
	{"青萝卜", "果蔬", "斤", "新鲜", "颜色青绿, 皮薄且较细, 肉质紧密, 形体完整, 水分大, 分量重。"},
	{"胡萝卜", "果蔬", "斤", "新鲜散装", "颜色红色或橘黄色, 表面光滑, 条直均匀, 粗壮, 硬实不软, 肉质甜脆, 中心柱细小。"},
	{"白萝卜", "果蔬", "斤", "新鲜", "颜色洁白光亮, 表面光滑细腻, 形体完整, 分量重, 底部切面洁白, 水分大, 肉嫩脆。"},
	{"芋头", "果蔬", "斤", "新鲜", "颜色红褐色, 表皮粗糙, 个体方面均中, 断面肉质洁白, 有紫色斑点, 不硬心。"},
	{"莲藕", "果蔬", "斤", "新鲜", "表皮颜色白中带黄, 藕节肥大, 无叉水分充足, 肉质白嫩脆, 藕节一般为3-4节。"},
	{"冬笋", "果蔬", "斤", "新鲜", "笋壳淡黄色, 有光泽, 完整清洁, 壳肉紧贴, 饱满, 肉质洁白较嫩, 很小。"},
	{"竹笋", "果蔬", "斤", "新鲜", "笋壳淡黄色, 有光泽, 笋体强壮, 充实, 饱满, 肉质洁白较嫩, 水分多。"},
	{"香菇", "果蔬", "斤", "新鲜", "菌盖颜色褐色, 有光泽, 菌耀为淡米色或乳白色, 菌身完整无损, 不湿, 菌盖大, 有弹性, 柄短小, 香味浓, 重量轻。"},
	{"平菇", "果蔬", "斤", "新鲜", "菌为洁白色或浅黑色, 菌身完整, 大小均匀, 菌盖与柄, 菌环相连未展开根短。"},
	{"草菇", "果蔬", "斤", "新鲜", "顶部颜色为鼠灰色, 根部为乳白色, 蛋或卵圆形, 饱满, 菌膜未破, 湿度适中。"},
	{"金针菇", "果蔬", "斤", "新鲜", "菌盖颜色乳白, 菌柄淡黄色, 根部淡褐色, 菌身细短。"},

	// --- 鲜（冻）水产品 ---
	{"鱼类(活)", "鲜（冻）水产品", "斤", "鲜活", "游水生猛, 对外刺激敏感, 无翻肚, 无嘴烂及其他外表损伤, 鱼鳞完整有光泽, 不易脱落, 眼隔膜有光泽, 透明, 眼球突出, 腹部坚实部膨胀, 肛门内部洁净, 无异常红尾, 大小均匀。"},
	{"虾类(活)", "鲜（冻）水产品", "斤", "鲜活", "游水快, 对外界刺激敏感, 头尾完善, 有一定的弯曲度, 虾眼突起, 虾身较挺, 肉质坚实, 虾壳发亮, 发硬, 呈青绿色或青白色。"},
	{"蟹类(活)", "鲜（冻）水产品", "斤", "鲜活", "蟹腿坚实, 肥壮, 手捏有硬感, 脐部饱满, 体重, 翻扣在地上能很快翻转过来, 外壳呈青色冷亮, 腹部发白。"},
	{"鳖(活)", "鲜（冻）水产品", "只", "鲜活", "体色正常, 体态完好, 四肢, 尾巴, 颈, 裙边等完好, 无腐烂, 用手翻个后能很快翻转过来。"},
	{"蛙类(活)", "鲜（冻）水产品", "斤", "鲜活", "大小均匀, 没有伤痕, 没有异味, 表皮光滑, 有较强的跳动活力。"},
	{"黄鳝(活)", "鲜（冻）水产品", "斤", "鲜活", "体色正常, 体态完整, 在水中头朝上直立, 捞离水后, 挣扎有力, 身上黏度较多, 个体较大。"},
	{"贝类", "鲜（冻）水产品", "斤", "鲜活", "肉质新鲜, 无臭味, 两贝壳相碰发出实响, 且响声均匀, 在静水中会伸出触角, 表面清洁完整, 无寄生物, 外观美观, 有光泽。"},
	{"冰鲜鱼", "鲜（冻）水产品", "斤", "冰鲜", "体表黏液透明, 而不粘, 气味正常, 腮盖紧闭, 淡水鱼鳃鲜红或粉红, 海水鱼鳃紫色或紫红, 鱼眼澄清透明, 眼球突出, 鱼鳞完整, 不易脱落, 鱼腹发白, 不膨胀, 肛内内缩, 鱼体肌肉有弹性, 不易压出凹陷或凹陷能迅速复平, 大小均匀, 体表无伤痕。"},
	{"冰鲜虾", "鲜（冻）水产品", "斤", "冰鲜", "头尾完整, 有一定弯曲度, 虾身较挺, 半透明不发红, 外壳有光泽, 稍湿润, 气味正常。"},
	{"冰鲜蟹", "鲜（冻）水产品", "斤", "冰鲜", "蟹腿坚实, 蟹壳纹理清楚, 光亮, 用手挟持背腹两面平直, 腿不下垂, 体重, 气味正常。"},
	{"冰鱿鱼", "鲜（冻）水产品", "斤", "冰鲜", "色鲜红, 皮微红, 有光泽, 多黏液, 体形完整, 肌肉柔软光滑, 有弹性。"},

	// --- 蛋类 ---
	{"鸡蛋", "蛋类", "板", "新鲜散装", "蛋壳粗糙, 色泽鲜明, 表面干净, 无任何斑点, 斑块, 敲击声音坚实, 清脆似碰击石头, 摇晃无响声, 无异味或有轻微腥味, 内容物透亮, 呈淡橘红色。"},
	{"咸蛋", "蛋类", "板", "新鲜散装", "咸蛋壳应完整, 无裂纹, 无破损, 表面清洁, 气室高度应小于7毫米, 蛋白纯白, 无斑点, 细嫩, 蛋黄色泽红黄, 煮熟后黄中起油或有油析出, 滋味咸味适中, 无异味, 蛋壳无裂痕。"},

	// --- 豆制品 ---
	{"盒装内酯嫩豆腐", "豆制品", "盒", "盒装", "白色或乳白色, 略有豆香、持水性较好, 刀切后不塌、不裂、细腻、嫩滑、无涩味。"},
	{"盒装内酯老豆腐", "豆制品", "盒", "盒装", "白色或乳白色, 略有豆香、持水性较好, 刀切后不塌、不裂、细腻、嫩滑、无涩味。"},
	{"石膏嫩豆腐", "豆制品", "斤", "散装", "乳白色, 有豆香, 不酸, 揭布后, 不脱皮, 不塌, 切口光亮, 持水性好, 滑爽不粗, 有石膏脚。"},
	{"石膏老豆腐", "豆制品", "斤", "散装", "乳白色, 有豆香, 不酸, 揭布后, 不脱皮, 不塌, 切口光亮, 持水性好, 滑爽不粗, 较密实, 有石膏脚。"},
	{"豆腐干(香干)", "豆制品", "斤", "散装", "淡黄色或黄色, 有豆香, 块型整齐, 厚薄均匀, 密实, 有韧性。"},
	{"五香豆腐干", "豆制品", "斤", "散装", "褐色, 有光泽, 五香味, 块形整齐, 厚薄均匀, 有韧性。"},
	{"熏香干", "豆制品", "斤", "散装", "淡褐色和淡黄色相间, 有辛香料柴火香, 块形整齐, 厚薄均匀, 有韧性。"},
	{"柴火干", "豆制品", "斤", "散装", "淡褐色和淡黄色相间, 有辛香料柴火香, 块形整齐, 厚薄均匀, 有韧性。"},
	{"油豆腐", "豆制品", "斤", "散装", "金黄色或黄色, 有油香和豆香, 方形、三角形或长条形, 皮薄软糯, 内呈蜂窝状, 不实心。"},
	{"油划方", "豆制品", "斤", "散装", "金黄色或黄色, 有油香和豆香, 方形或菱形, 大小均匀, 不碎。"},
	{"素鸡", "豆制品", "斤", "散装", "乳白色或淡米色, 稍带碱味, 圆柱形, 无裂缝, 不烂心。"},
	{"薄百页", "豆制品", "斤", "散装", "淡黄色, 有豆香, 方形薄张, 无白边, 白头, 花洞厚薄均匀, 有韧性, 稍有拉力。"},
	{"豆腐衣", "豆制品", "斤", "散装", "乳白色, 有豆香, 方形薄张, 无白边、白头、花洞厚薄均匀, 有韧性, 稍有拉力。"},
	{"豆浆", "豆制品", "盒", "盒装", "乳白色或淡黄色, 有豆香, 有光泽, 呈混悬液型, 质地细腻, 无结块。"},
	{"腐竹", "豆制品", "斤", "散装", "淡黄色, 有光泽, 透过光线可见纤维组织, 有弹性。"},
	{"豆鼓", "豆制品", "斤", "散装", "黑褐色或黑色, 有豆香, 无异味, 质地较硬。"},

	// --- 面筋制品 ---
	{"栗子面筋", "面筋制品", "斤", "散装", "灰白色、有麦色、无酸味、栗子状, 有韧性。"},
	{"素肠", "面筋制品", "斤", "散装", "灰白色、有麦色、无酸味、猪肠状, 不包头, 有韧性。"},
	{"烤麸", "面筋制品", "斤", "散装", "米黄色, 有麦色、无异味、蜂窝状, 松软, 僵底高度≤5mm。"},
	{"油面筋", "面筋制品", "斤", "散装", "金黄色, 有油香, 无异味, 呈球状, 内呈丝网状。"},
}

func toPtr(s string) *string {
	if strings.TrimSpace(s) == "" {
		return nil
	}
	return &s
}

func collectUnique(values []string) []string {
	uniq := make(map[string]struct{}, len(values))
	for _, v := range values {
		if v == "" {
			continue
		}
		uniq[v] = struct{}{}
	}
	out := make([]string, 0, len(uniq))
	for k := range uniq {
		out = append(out, k)
	}
	sort.Strings(out)
	return out
}

func loadSpecIDs(ctx context.Context, db *gorm.DB, names []string) (map[string]string, error) {
	if len(names) == 0 {
		return map[string]string{}, nil
	}

	var specs []dict.Spec
	if err := db.WithContext(ctx).Where("name IN ?", names).Find(&specs).Error; err != nil {
		return nil, fmt.Errorf("查询规格失败: %w", err)
	}
	result := make(map[string]string, len(specs))
	for _, sp := range specs {
		result[sp.Name] = sp.ID
	}

	for _, name := range names {
		if _, ok := result[name]; !ok {
			return nil, fmt.Errorf("未找到规格 '%s'，请先初始化 base_spec", name)
		}
	}
	return result, nil
}

func loadUnitIDs(ctx context.Context, db *gorm.DB, names []string) (map[string]string, error) {
	if len(names) == 0 {
		return map[string]string{}, nil
	}

	var units []dict.Unit
	if err := db.WithContext(ctx).Where("name IN ?", names).Find(&units).Error; err != nil {
		return nil, fmt.Errorf("查询单位失败: %w", err)
	}
	result := make(map[string]string, len(units))
	for _, un := range units {
		result[un.Name] = un.ID
	}

	for _, name := range names {
		if _, ok := result[name]; !ok {
			return nil, fmt.Errorf("未找到单位 '%s'，请先初始化 base_unit", name)
		}
	}
	return result, nil
}

func loadCategoryIDs(ctx context.Context, db *gorm.DB, names []string) (map[string]string, error) {
	if len(names) == 0 {
		return map[string]string{}, nil
	}

	var categories []category.Category
	if err := db.WithContext(ctx).Where("name IN ?", names).Find(&categories).Error; err != nil {
		return nil, fmt.Errorf("查询品类失败: %w", err)
	}
	result := make(map[string]string, len(categories))
	for _, cat := range categories {
		result[cat.Name] = cat.ID
	}

	for _, name := range names {
		if _, ok := result[name]; !ok {
			return nil, fmt.Errorf("未找到品类 '%s'，请先初始化 base_category", name)
		}
	}
	return result, nil
}

func upsertGoods(ctx context.Context, db *gorm.DB, row *goods.Goods) error {
	assignments := map[string]any{
		"category_id": row.CategoryID,
		"spec_id":     row.SpecID,
		"unit_id":     row.UnitID,
		"is_deleted":  0,
		"updated_at":  time.Now(),
	}
	if row.ImageURL != nil {
		assignments["image_url"] = *row.ImageURL
	} else {
		assignments["image_url"] = nil
	}
	if row.AcceptanceStandard != nil {
		assignments["acceptance_standard"] = *row.AcceptanceStandard
	} else {
		assignments["acceptance_standard"] = nil
	}

	return db.WithContext(ctx).
		Clauses(clause.OnConflict{
			Columns:   []clause.Column{{Name: "org_id"}, {Name: "name"}, {Name: "spec_id"}},
			DoUpdates: clause.Assignments(assignments),
		}).
		Create(row).Error
}

func EnsureDefaultGoods(ctx context.Context, gdb *gorm.DB) error {
	specNames := make([]string, 0, len(defaultGoods))
	unitNames := make([]string, 0, len(defaultGoods))
	categoryNames := make([]string, 0, len(defaultGoods))
	for _, g := range defaultGoods {
		specNames = append(specNames, g.SpecName)
		unitNames = append(unitNames, g.UnitName)
		categoryNames = append(categoryNames, g.CategoryName)
	}

	specIDs, err := loadSpecIDs(ctx, gdb, collectUnique(specNames))
	if err != nil {
		return err
	}

	unitIDs, err := loadUnitIDs(ctx, gdb, collectUnique(unitNames))
	if err != nil {
		return err
	}

	categoryIDs, err := loadCategoryIDs(ctx, gdb, collectUnique(categoryNames))
	if err != nil {
		return err
	}

	success := 0
	for _, item := range defaultGoods {
		row := &goods.Goods{
			Name:               item.Name,
			OrgID:              DefaultOrgID,
			SpecID:             specIDs[item.SpecName],
			UnitID:             unitIDs[item.UnitName],
			CategoryID:         categoryIDs[item.CategoryName],
			AcceptanceStandard: toPtr(item.AcceptanceStandard),
			Sort:               0,
		}
		if err := upsertGoods(ctx, gdb, row); err != nil {
			logger.L().Error("Failed to seed goods", zap.Error(err),
				zap.String("name", item.Name),
			)
			return err
		}
		success++
	}

	logger.L().Info("Goods seeded/ensured",
		zap.Int("count", success),
		zap.String("org_id", DefaultOrgID),
	)
	return nil
}
