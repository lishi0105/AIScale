# Excel导入询价记录接口文档

## 接口概述

该接口用于从Excel文件导入询价记录，支持自动创建或更新商品、品类、规格、单位和供应商等基础数据。

## 接口地址

```
POST /api/inquiry/import_excel
```

## 请求参数

- **Content-Type**: `multipart/form-data`
- **参数**:
  - `org_id` (string, required): 组织ID，必须是UUID格式
  - `file` (file, required): Excel文件（.xlsx格式）

## 权限要求

- 需要管理员角色
- 账户必须处于激活状态

## Excel文件格式要求

### 1. 必须包含标题行

Excel文件的第一行应包含标题，例如：
```
2025年9月上旬都匀市主要蔬菜类市场参考价
```

### 2. 工作表（Sheet）命名

每个工作表的名称将作为商品品类（category）的名称，例如：
- 蔬菜类
- 水产海鲜
- 水果
- 肉、禽、蛋
- 牛奶饮品
- 干货调料
- 冻品、豆制品

### 3. 表头要求

表头必须包含以下列：

#### 必选列
- **品名**: 商品名称
- **规格标准**: 商品规格
- **单位**: 计量单位
- **本期均价**: 平均价格

#### 询价市场列（至少3个）
必须包含至少3个市场询价列，列名应包含以下关键字之一：
- 超市
- 市场
- 商店
- 发

示例：
- 富万家超市
- 育英巷菜市场
- 大润发

#### 供应商列（至少1个）
必须包含至少1个供应商结算价列，格式为：
```
{供应商名称}本期结算价（下浮{百分比}%）
```

示例：
- 胡坤本期结算价（下浮12%）
- 贵海本期结算价（下浮14%）

**注意**：下浮比例将被转换为浮动比例存储：
- 下浮12% → float_ratio = 0.88
- 下浮14% → float_ratio = 0.86

### 4. 数据行

每一行代表一个商品的询价数据，包含：
- 商品基本信息（品名、规格、单位）
- 各市场的询价价格
- 本期均价
- 各供应商的结算价

## Excel示例结构

```
序号 | 品名 | 规格标准 | 单位 | 发改委指导价 | 富万家超市 | 育英巷菜市场 | 大润发 | 上月均价 | 本期均价 | 胡坤本期结算价（下浮12%） | 贵海本期结算价（下浮14%）
-----|------|----------|------|-------------|-----------|-------------|--------|----------|----------|-------------------------|-------------------------
9    | 仔姜 | 新鲜     | 斤   |             | 9.8       | 10          | 9.88   | 17.47    | 9.89     | 8.71                    | 8.51
10   | 丝瓜 | 新鲜     | 斤   |             | 5.58      | 5.8         | 7.2    | 7.38     | 6.19     | 5.45                    | 5.33
```

## 导入处理逻辑

### 1. 品类（Category）处理
- 如果数据库中不存在该品类名称，则自动创建新品类
- 品类名称来自工作表名称

### 2. 规格（Spec）和单位（Unit）处理
- 如果数据库中不存在对应的规格或单位，则自动创建
- 如果Excel中规格或单位为空，则使用默认值：
  - 规格默认值：`未分类`
  - 单位默认值：`个`

### 3. 商品（Goods）处理
- 根据"品名"、"规格"、"单位"和"组织ID"查找商品
- 如果不存在，则创建新商品
- 商品会关联到对应的品类、规格和单位

### 4. 供应商（Supplier）处理
- 根据供应商名称和组织ID查找供应商
- 如果不存在，则创建新供应商
- 如果已存在但浮动比例不同，则更新浮动比例

### 5. 询价记录（PriceInquiry）创建
- 为每个工作表创建一条询价记录
- 记录标题、日期、市场信息等

### 6. 商品均价明细（GoodsAvgDetail）创建
- 为每个商品创建均价明细记录
- 包含各市场价格和本期均价

### 7. 商品单价（GoodsPrice）创建
- 为每个商品的每个供应商创建单价记录
- 包含供应商报价和浮动比例快照

## 请求示例

### cURL

```bash
curl -X POST "http://localhost:8080/api/inquiry/import_excel" \
  -H "Authorization: Bearer {your_token}" \
  -F "org_id=123e4567-e89b-12d3-a456-426614174000" \
  -F "file=@/path/to/your/excel/file.xlsx"
```

### JavaScript (使用 FormData)

```javascript
const formData = new FormData();
formData.append('org_id', '123e4567-e89b-12d3-a456-426614174000');
formData.append('file', fileInput.files[0]);

fetch('/api/inquiry/import_excel', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${token}`
  },
  body: formData
})
.then(response => response.json())
.then(data => console.log(data));
```

## 响应示例

### 成功响应

```json
{
  "message": "导入成功"
}
```

HTTP状态码: 200

### 失败响应

```json
{
  "error": "导入Excel失败",
  "message": "Excel表格必须包含品名/规格标准/单位/本期均价四项"
}
```

HTTP状态码: 400/403/500

## 错误处理

### 常见错误

1. **缺少必需列**: 确保Excel表格包含所有必需的列（品名、规格标准、单位、本期均价）
2. **市场数量不足**: 必须包含至少3个市场询价列
3. **供应商数量不足**: 必须包含至少1个供应商结算价列
4. **格式错误**: 供应商列必须符合格式要求，包含下浮百分比
5. **权限错误**: 仅管理员可执行导入操作
6. **文件格式错误**: 仅支持.xlsx格式的Excel文件

## 注意事项

1. 导入操作使用数据库事务，如果任何步骤失败，整个导入将回滚
2. 价格字段可以为空，系统会自动处理空值
3. 供应商的浮动比例会在导入时更新，以Excel中的值为准
4. 商品、品类、规格、单位等基础数据会自动创建，无需预先准备
5. 同一组织内的品类、供应商名称必须唯一
6. 上传的文件会临时保存在服务器的/tmp目录下

## 数据库影响

导入操作会影响以下数据表：

1. `base_category` - 品类
2. `base_spec` - 规格
3. `base_unit` - 单位
4. `base_goods` - 商品
5. `supplier` - 供应商
6. `base_price_inquiry` - 询价记录
7. `base_goods_avg_detail` - 商品均价明细
8. `base_goods_price` - 商品单价
